import openpyxl
from openpyxl.utils import get_column_letter
from openpyxl.worksheet.table import Table, TableStyleInfo

def filter_records_by_sales():
    wb = openpyxl.load_workbook('YourWorkbook.xlsx')

    ws_source1 = wb['Sheet1']
    ws_source2 = wb['Sheet2']

    try:
        ws_dest = wb['FilteredData']
    except KeyError:
        ws_dest = wb.create_sheet('FilteredData')
        ws_dest.sheet_properties.tabColor = "1072BA"
    
    # Clear existing data in the destination sheet
    for row in ws_dest.iter_rows(min_row=2, max_row=ws_dest.max_row, min_col=1, max_col=ws_dest.max_column):
        for cell in row:
            cell.value = None

    last_row1 = ws_source1.max_row
    last_row2 = ws_source2.max_row

    header_last_column = ws_source1.max_column

    # Copy headers to destination sheet
    for col_num in range(1, header_last_column + 1):
        ws_dest.cell(row=1, column=col_num).value = ws_source1.cell(row=1, column=col_num).value

    ws_dest.cell(row=1, column=header_last_column + 1).value = "Total Sale"
    ws_dest.cell(row=1, column=header_last_column + 2).value = "CreatedDate"
    ws_dest.cell(row=1, column=header_last_column + 3).value = "SortCode"

    dest_row = 2

    for i in range(2, last_row1 + 1):
        segment = ws_source1.cell(row=i, column=1).value

        for j in range(2, last_row2 + 1):
            if ws_source2.cell(row=j, column=1).value == segment:
                if ws_source1.cell(row=i, column=10).value > 2000 and ws_source1.cell(row=i, column=11).value > 10000:
                    total_sale = ws_source1.cell(row=i, column=7).value * ws_source1.cell(row=i, column=5).value
                    unused_variable = ws_source1.cell(row=i, column=8).value

                    if ws_source1.cell(row=i, column=16).value == 2014:
                        created_date = ws_source1.cell(row=i, column=16).value + 1
                    else:
                        created_date = ws_source1.cell(row=i, column=16).value

                    print(f"Created Date: {created_date}")

                    sort_code = ws_source2.cell(row=j, column=2).value

                    for k in range(1, header_last_column + 1):
                        ws_dest.cell(row=dest_row, column=k).value = ws_source1.cell(row=i, column=k).value

                    ws_dest.cell(row=dest_row, column=header_last_column + 1).value = total_sale
                    ws_dest.cell(row=dest_row, column=header_last_column + 2).value = created_date
                    ws_dest.cell(row=dest_row, column=header_last_column + 3).value = sort_code

                    dest_row += 1

    wb.save('YourWorkbook.xlsx')

# Call the function
filter_records_by_sales()
