import argparse
from PIL import Image, ImageChops, ImageDraw
import sys

def image_diff(image1, image2, output_path):
    # Open the images
    img1 = Image.open(image1)
    img2 = Image.open(image2)

    # Ensure images have the same size
    if img1.size != img2.size:
        raise ValueError("Images must have the same dimensions for comparison.")

    # Create a "difference" image
    diff = ImageChops.difference(img1, img2)
    diff = diff.convert("RGB")

    # Highlight differences in red
    draw = ImageDraw.Draw(diff)
    width, height = diff.size
    for x in range(width):
        for y in range(height):
            r, g, b = diff.getpixel((x, y))
            if r > 0 or g > 0 or b > 0:
                draw.rectangle([x, y, x+1, y+1], fill=(255, 0, 0))

    # Save the difference image
    diff.save(output_path)

    # Calculate total difference (count of differing pixels)
    total_diff = diff.getbbox()
    
    return total_diff

def main():
    parser = argparse.ArgumentParser(description="Compare two screenshots.")
    parser.add_argument("image1", help="Path to the first image")
    parser.add_argument("image2", help="Path to the second image")
    parser.add_argument("output", help="Path to save the difference image")
    
    args = parser.parse_args()
    
    try:
        difference = image_diff(args.image1, args.image2, args.output)
        print(f"Total differing pixels: {difference}")
        
        # Exit with a non-zero code if images are different
        if difference:
            sys.exit(1)
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
