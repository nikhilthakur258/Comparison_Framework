import openpyxl
import logging
import pyautogui
import time
from openpyxl import load_workbook

# Configure logging
logging.basicConfig(filename='automation_log.log', level=logging.INFO, format='%(asctime)s - %(levelname)s: %(message)s')

# Step 1: Open xlsm file
file_path = "your_file.xlsm"
workbook = load_workbook(filename=file_path, read_only=False, keep_vba=True)

# Log opening file
logging.info(f"Opened file: {file_path}")

# Step 2: On Main worksheet, click on Reconnect DB Button
main_sheet = workbook["Main"]

# Assuming Reconnect DB Button is at row 8, column 9
reconnect_button = main_sheet.cell(row=8, column=9)

# Get the screen coordinates of the cell
cell_position = pyautogui.position(x=reconnect_button.column, y=reconnect_button.row)

# Log clicking on Reconnect DB Button
logging.info("Clicking on Reconnect DB Button")
print(f"Clicking on Reconnect DB Button at coordinates: {cell_position}")
pyautogui.click(cell_position.x, cell_position.y)
time.sleep(2)  # Add a pause to observe the action

# Step 3: Go to line 16, column E, select ACBS from dropdown
line_number = 16
column_letter = 'E'
cell_address = f"{column_letter}{line_number}"

# Assuming a dropdown is a data validation list in cell E16
# This selects "ACBS" from the dropdown
main_sheet[cell_address].data_validation = openpyxl.worksheet.datavalidation.DataValidation(
    type="list", formula1='"ACBS"', allow_blank=True)
logging.info(f"Selected ACBS in the dropdown at cell: {cell_address}")
print(f"Selected ACBS in the dropdown at cell: {cell_address}")
time.sleep(2)  # Add a pause to observe the action

# Step 4: Click on Enter TrialBal Adj button
# Click on the button at specified coordinates (993, 609)
logging.info("Clicking on button at coordinates (993, 609)")
print("Clicking on Enter TrialBal Adj button at coordinates (993, 609)")
pyautogui.click(993, 609)
time.sleep(2)  # Add a pause to observe the action

# Save the changes
workbook.save("updated_file.xlsm")

# Log saving changes
logging.info("Saved changes to the file")

# Take a screenshot
screenshot_path = "screenshot.png"
pyautogui.screenshot(screenshot_path)

# Log taking a screenshot
logging.info(f"Took a screenshot and saved it at: {screenshot_path}")
