DECLARE @SQL NVARCHAR(MAX)
DECLARE @HTMLResult NVARCHAR(MAX) = '';

-- Create a temporary table to store the results
CREATE TABLE #ResultTable (
    SchemaName NVARCHAR(255),
    TableName NVARCHAR(255),
    ColumnName NVARCHAR(255),
    CountDuplicates INT
);

-- Generate dynamic SQL for each table and column
SET @SQL = 
    'INSERT INTO #ResultTable ' +
    'SELECT ' +
        's.name AS SchemaName, ' +
        't.name AS TableName, ' +
        'c.name AS ColumnName, ' +
        'COUNT(*) AS CountDuplicates ' +
    'FROM sys.tables t ' +
    'INNER JOIN sys.schemas s ON t.schema_id = s.schema_id ' +
    'INNER JOIN sys.columns c ON t.object_id = c.object_id ' +
    'GROUP BY s.name, t.name, c.name ' +
    'HAVING COUNT(*) > 1';

-- Execute dynamic SQL
EXEC sp_executesql @SQL;

-- Output the HTML result
SET @HTMLResult = @HTMLResult + '<html><head></head><body><table border="1"><tr><th>Schema Name</th><th>Table Name</th><th>Column Name</th><th>Duplicate Row Count</th></tr>';
INSERT INTO #ResultTable VALUES ('Schema1', 'Table1', 'Column1', 5), ('Schema1', 'Table1', 'Column2', 3); -- Replace with actual data from #ResultTable

SELECT @HTMLResult = @HTMLResult + '<tr><td>' + SchemaName + '</td><td>' + TableName + '</td><td>' + ColumnName + '</td><td>' + CAST(CountDuplicates AS NVARCHAR(MAX)) + '</td></tr>' FROM #ResultTable;
SET @HTMLResult = @HTMLResult + '</table></body></html>';

-- Drop the temporary table
DROP TABLE #ResultTable;

-- Output the HTML result
SELECT @HTMLResult AS HTMLResult;
